@model IEnumerable<NguyenXuanVinh_Project2.Models.Book>
@using System.Net
@using Microsoft.AspNetCore.Http

@{
    ViewData["Title"] = "Danh Sách Truyện";
    var role = Context.Session.GetString("Role");
    var username = Context.Session.GetString("Username");
}

<div class="container my-4">
    <div class="row g-4">
        <!-- ==== SIDEBAR ==== -->
        <div class="col-md-3">
            <div class="sidebar shadow-sm p-3 bg-white rounded-4">
                <h5 class="fw-bold text-success mb-3">
                    <i class="bi bi-grid-3x3-gap"></i> Danh mục
                </h5>
                <ul class="list-group mb-4">
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index">
                            <i class="bi bi-collection"></i> Tất cả
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Shounen">
                            🔥 Shounen
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Shoujo">
                            📚 Shoujo
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Seinen">
                            ⚡ Seinen
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Isekai">
                            🎭 Isekai
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Fantasy">
                            💖 Fantasy
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Hành động">
                            ⚔️ Action
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Phiêu lưu">
                            🗺️ Adventure
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a asp-controller="Books" asp-action="Index" asp-route-category="Truyện chữ">
                            ✍️ Light Novel
                        </a>
                    </li>
                </ul>

                <h5 class="fw-bold text-success mb-3">
                    <i class="bi bi-funnel"></i> Bộ lọc giá
                </h5>
                <form method="get" asp-action="Index">
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="price" value="1" id="p1" onchange="this.form.submit()">
                        <label class="form-check-label" for="p1">< 50.000đ</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="price" value="2" id="p2" onchange="this.form.submit()">
                        <label class="form-check-label" for="p2">50.000đ – 100.000đ</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="price" value="3" id="p3" onchange="this.form.submit()">
                        <label class="form-check-label" for="p3">100.000đ – 200.000đ</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="price" value="4" id="p4" onchange="this.form.submit()">
                        <label class="form-check-label" for="p4">200.000đ – 300.000đ</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="price" value="5" id="p5" onchange="this.form.submit()">
                        <label class="form-check-label" for="p5">> 300.000đ</label>
                    </div>
                </form>
            </div>
        </div>

        <!-- ==== MAIN CONTENT ==== -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-success">
                    <i class="bi bi-book-half"></i> Danh Sách Truyện
                </h2>

                @if (role == "Admin")
                {
                    <div class="btn-group">
                        <a href="@Url.Action("Create","Books")" class="btn btn-sm btn-success">
                            <i class="bi bi-plus-circle"></i> Thêm
                        </a>
                        <a href="@Url.Action("Index","Admin")" class="btn btn-sm btn-warning">
                            <i class="bi bi-gear-fill"></i> Quản Trị
                        </a>
                    </div>
                }
            </div>

            <!-- ==== MESSAGE / ALERT ==== -->
            @if (TempData["Message"] != null)
            {
                <div class="alert alert-info alert-dismissible fade show text-center fade-alert" role="alert">
                    <i class="bi bi-info-circle animated-icon"></i> @TempData["Message"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            else if (Model == null || !Model.Any())
            {
                <div class="alert alert-warning text-center fade-alert">
                    <i class="bi bi-exclamation-triangle animated-icon"></i> Không tìm thấy truyện nào phù hợp với yêu cầu của bạn.
                </div>
            }
            else
            {
                <div class="alert alert-success text-center fade-alert">
                    <i class="bi bi-check-circle animated-icon"></i> Tìm thấy <strong>@Model.Count()</strong> truyện phù hợp!
                </div>
            }

            <!-- ==== BOOKS GRID ==== -->
            @if (Model != null && Model.Any())
            {
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
                    @foreach (var item in Model)
                    {
                        <div class="col">
                            <div class="card h-100 shadow-sm border-0 product-card">
                                @{
                                    var imgSrc = !string.IsNullOrEmpty(item.Picture) &&
                                    (item.Picture.StartsWith("http://") || item.Picture.StartsWith("https://"))
                                    ? item.Picture
                                    : Url.Content("~/images/books/" + (item.Picture ?? "no-cover.jpg"));
                                }
                                <img src="@imgSrc"
                                     alt="@Html.Raw(WebUtility.HtmlDecode(item.Title ?? "Không rõ"))"
                                     class="card-img-top book-img"
                                     onerror="this.onerror=null; this.src='/images/books/no-cover.jpg';" />

                                <div class="card-body text-center">
                                    <h6 class="card-title text-truncate fw-semibold"
                                        title="@Html.Raw(WebUtility.HtmlDecode(item.Title ?? "Không rõ"))">
                                        @Html.Raw(WebUtility.HtmlDecode(item.Title ?? "Không rõ"))
                                    </h6>
                                    <p class="author text-muted small mb-1">
                                        <i class="bi bi-person-circle"></i>
                                        @Html.Raw(WebUtility.HtmlDecode(item.Author ?? "Không rõ"))
                                    </p>
                                    <p class="price text-success fw-bold mb-2">
                                        <i class="bi bi-cash-stack"></i>
                                        @(item.Price?.ToString("N0") ?? "0") đ
                                    </p>
                                </div>

                                <div class="card-footer bg-white border-0 d-flex justify-content-center gap-1">
                                    @if (role == "Admin")
                                    {
                                        <a href="@Url.Action("Edit", new { id = item.BookId })"
                                           class="btn btn-sm btn-outline-primary" title="Sửa">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <a href="@Url.Action("Delete", new { id = item.BookId })"
                                           class="btn btn-sm btn-outline-danger" title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    }

                                    <a href="@Url.Action("Details", new { id = item.BookId })"
                                       class="btn btn-sm btn-outline-info" title="Chi tiết">
                                        <i class="bi bi-info-circle"></i>
                                    </a>

                                    <button type="button" class="btn btn-sm btn-outline-success add-to-cart"
                                            data-id="@item.BookId" title="Thêm vào giỏ">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Bootstrap Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="cartToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body fw-semibold">
                <i class="bi bi-check-circle me-2"></i> Đã thêm sản phẩm vào giỏ hàng!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {
            // Add to cart logic
            $(".add-to-cart").click(function () {
                var id = $(this).data("id");
                $.post('/Cart/AddToCart', { id: id })
                    .done(function (res) {
                        if (res && res.count !== undefined) {
                            $("#cart-count").text(res.count);
                        }
                        const toast = new bootstrap.Toast(document.getElementById('cartToast'));
                        toast.show();
                    })
                    .fail(function () {
                        alert("Không thể thêm sản phẩm vào giỏ.");
                    });
            });

            // Auto fade alerts after 3s
            setTimeout(() => {
                $(".fade-alert").fadeOut(800);
            }, 3000);
        });
    </script>

}
