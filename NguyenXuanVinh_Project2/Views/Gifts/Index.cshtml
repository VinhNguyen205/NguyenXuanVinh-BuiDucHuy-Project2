@model IEnumerable<NguyenXuanVinh_Project2.Models.Gift>
@using System.Net

@{
    ViewData["Title"] = "Quà Tặng";
    var role = Context.Session.GetString("Role");
}

<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-success">
            <i class="bi bi-gift-fill"></i> Quà Tặng Đặc Biệt
        </h1>
        <p class="text-muted">Quà tặng đi kèm hoặc có thể mua riêng</p>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success fade-alert text-center" id="successAlert">
            <i class="bi bi-check-circle"></i> @TempData["Success"]
        </div>
    }

    @if (role == "Admin")
    {
        <div class="text-end mb-4">
            <a href="@Url.Action("Create", "Gifts")" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Thêm Quà Tặng
            </a>
        </div>
    }

    <div class="items-grid">
        @if (Model != null && Model.Any())
        {
            @foreach (var item in Model)
            {
                <div class="card h-100 product-card">
                    @{
                        var imgSrc = !string.IsNullOrEmpty(item.Picture) &&
                        (item.Picture.StartsWith("http://") || item.Picture.StartsWith("https://"))
                        ? item.Picture
                        : Url.Content("~/images/gifts/" + (item.Picture ?? "no-gift.jpg"));
                    }

                    <div class="position-relative">
                        <img src="@imgSrc"
                             alt="@Html.Raw(WebUtility.HtmlDecode(item.GiftName ?? "Không rõ"))"
                             class="card-img-top book-img"
                             loading="lazy"
                             onerror="this.onerror=null; this.src='/images/gifts/no-gift.jpg';" />
                        <span class="badge bg-danger position-absolute top-0 end-0 m-2">
                            <i class="bi bi-gift"></i> Quà
                        </span>
                    </div>

                    <div class="card-body text-center">
                        <h6 class="card-title text-truncate fw-semibold"
                            title="@Html.Raw(WebUtility.HtmlDecode(item.GiftName ?? "Không rõ"))">
                            @Html.Raw(WebUtility.HtmlDecode(item.GiftName ?? "Không rõ"))
                        </h6>
                        <p class="text-muted small mb-1">
                            @Html.Raw(WebUtility.HtmlDecode(item.Description ?? ""))
                        </p>
                        <p class="price text-success fw-bold mb-2">
                            <i class="bi bi-cash-stack"></i>
                            @string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:N0} đ", item.Price ?? 0)
                        </p>
                    </div>

                    <div class="card-footer bg-white border-0 d-flex justify-content-center gap-2">
                        <a href="@Url.Action("Details", "Gifts", new { id = item.GiftId })"
                           class="btn btn-sm btn-outline-info" title="Xem chi tiết quà tặng">
                            <i class="bi bi-info-circle"></i>
                        </a>

                        <button type="button" class="btn btn-sm btn-outline-success add-gift"
                                data-id="@item.GiftId" title="Thêm vào giỏ">
                            <i class="bi bi-cart-plus"></i>
                        </button>

                        @if (role == "Admin")
                        {
                            <a href="@Url.Action("Delete", "Gifts", new { id = item.GiftId })"
                               class="btn btn-sm btn-outline-danger" title="Xóa quà tặng">
                                <i class="bi bi-trash"></i>
                            </a>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-5">
                <i class="bi bi-gift display-5 text-muted"></i>
                <h4 class="text-muted mt-3">Chưa có quà tặng nào</h4>
                <p class="text-muted">Vui lòng quay lại sau!</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Làm mờ alert sau 3s
        setTimeout(() => {
            const alert = document.getElementById("successAlert");
            if (alert) alert.style.opacity = "0";
        }, 3000);

        // Add gift to cart
        $(function () {
            $(".add-gift").click(function () {
                const id = $(this).data("id");
                $.post('/Cart/AddGiftToCart', { id: id })
                    .done(function (res) {
                        if (res && res.count !== undefined) {
                            $("#cart-count").text(res.count);
                            pulseElement(document.querySelector('#cart-count'));
                        }
                        showCustomToast('Đã thêm quà tặng vào giỏ hàng!', { durationMs: 3000, type: 'success' });
                    })
                    .fail(function () {
                        showCustomToast('Không thể thêm quà tặng.', { durationMs: 3000, type: 'error' });
                    });
            });
        });
    </script>
}
